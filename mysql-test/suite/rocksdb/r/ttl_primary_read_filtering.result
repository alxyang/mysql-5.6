DROP TABLE IF EXISTS t1;
SET @@global.rocksdb_update_cf_options = 'default={disable_auto_compactions=true;};';
CREATE TABLE t1 (
a int PRIMARY KEY
) ENGINE=rocksdb
COMMENT='ttl_duration=1;';
INSERT INTO t1 values (1);
INSERT INTO t1 values (2);
set global rocksdb_force_flush_memtable_now=1;
SELECT * FROM t1;
a
select variable_value-@c from information_schema.global_status where variable_name='rocksdb_rows_expired';
variable_value-@c
NULL
set global rocksdb_compact_cf='default';
select variable_value-@c from information_schema.global_status where variable_name='rocksdb_rows_expired';
variable_value-@c
NULL
DROP TABLE t1;
CREATE TABLE t1 (
a int PRIMARY KEY,
b BIGINT UNSIGNED NOT NULL
) ENGINE=rocksdb
COMMENT='ttl_duration=5;';
INSERT INTO t1 values (1, UNIX_TIMESTAMP());
INSERT INTO t1 values (2, UNIX_TIMESTAMP());
INSERT INTO t1 values (3, UNIX_TIMESTAMP());
set global rocksdb_force_flush_memtable_now=1;
SELECT a FROM t1;
a
2
3
set global rocksdb_compact_cf='default';
SELECT a FROM t1;
a
2
3
SELECT a FROM t1;
a
DROP TABLE t1;
CREATE TABLE t1 (
a int,
b int,
c int,
PRIMARY KEY (a,b,c)
) ENGINE=rocksdb
COMMENT='ttl_duration=1;';
INSERT INTO t1 values (0,0,0);
INSERT INTO t1 values (0,0,1);
INSERT INTO t1 values (0,1,0);
INSERT INTO t1 values (0,1,1);
INSERT INTO t1 values (1,1,2);
INSERT INTO t1 values (1,2,1);
INSERT INTO t1 values (1,2,2);
INSERT INTO t1 values (1,2,3);
select variable_value into @c from information_schema.global_status where variable_name='rocksdb_rows_expired';
set global rocksdb_force_flush_memtable_now=1;
SELECT * FROM t1 WHERE a=1 AND b=2 AND c=2;
a	b	c
SELECT * FROM t1 WHERE a = 1;
a	b	c
SELECT max(a) from t1 where a < 3;
max(a)
NULL
SELECT max(a) from t1 where a < 2 AND b = 1 AND c < 3;
max(a)
NULL
SELECT min(a) from t1 where a >= 1;
min(a)
NULL
SELECT min(a) from t1 where a > 1;
min(a)
NULL
select * from t1 where a=1 and b in (1) order by c desc;
a	b	c
select max(a) from t1 where a <=10;
max(a)
NULL
select a from t1 where a > 0 and a <= 2;
a
select variable_value-@c from information_schema.global_status where variable_name='rocksdb_rows_expired';
variable_value-@c
0
set global rocksdb_compact_cf='default';
select variable_value-@c from information_schema.global_status where variable_name='rocksdb_rows_expired';
variable_value-@c
8
DROP TABLE t1;
CREATE TABLE t1 (
a int PRIMARY KEY
) ENGINE=rocksdb
COMMENT='ttl_duration=1;';
INSERT INTO t1 values (1);
set global rocksdb_force_flush_memtable_now=1;
SELECT * FROM t1;
a
INSERT INTO t1 values (1);
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
DROP TABLE t1;
CREATE TABLE t1 (
a int PRIMARY KEY
) ENGINE=rocksdb
COMMENT='ttl_duration=1;';
INSERT INTO t1 values (1);
SELECT * FROM t1;
a
UPDATE t1 set a = 1;
DROP TABLE t1;
CREATE TABLE t1 (
a int PRIMARY KEY
) ENGINE=rocksdb
COMMENT='ttl_duration=4;';
INSERT INTO t1 values (1);
INSERT INTO t1 values (3);
INSERT INTO t1 values (5);
INSERT INTO t1 values (7);
UPDATE t1 set a = 1;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
UPDATE t1 set a = 999 where a = 5;
SELECT * FROM t1;
a
7
999
UPDATE t1 set a = a - 1;
SELECT * FROM t1;
a
6
998
DROP TABLE t1;
CREATE TABLE t1 (
a int PRIMARY KEY
) ENGINE=rocksdb
COMMENT='ttl_duration=3;';
INSERT INTO t1 values (1);
INSERT INTO t1 values (3);
INSERT INTO t1 values (5);
INSERT INTO t1 values (7);
# Creating Snapshot (start transaction)
BEGIN;
SELECT * FROM t1;
a
1
3
5
7
SELECT * FROM t1;
a
1
3
5
7
# Switching to connection 2
set global rocksdb_force_flush_memtable_now=1;
set global rocksdb_compact_cf='default';
SELECT * FROM t1;
a
# Switching to connection 1
SELECT * FROM t1;
a
1
3
5
7
UPDATE t1 set a = a + 1;
SELECT * FROM t1;
a
2
4
6
8
COMMIT;
SELECT * FROM t1;
a
DROP TABLE t1;
SET @@global.rocksdb_update_cf_options = '';
